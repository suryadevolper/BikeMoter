/********************* Wishlist Api Call Starts *********************/
function apiWishListAdd() {
    var dataMapping = _getDataMapping();
    var cust_token = dataMapping.customerDetails.api.customerToken;
    var customerID = cust_token ? cust_token : "";
    reqObj = {
        requestJson: {
            customer_id: customerID
        },
        entityId: parseInt(targetWishlistObj.productId)
    };
    apiUtility.wishlist(reqObj).then(function (response) {
        console.log("response: ", response);
        if (response && response.status) {
            $(targetWishlistObj.targetParent).find(".wishlist-remove-event").addClass("active");
            $(targetWishlistObj.targetParent).find(".wishlist-add-event").removeClass("active");
            showToasterMsg(response.message, true);
        } else {
            showToasterMsg(response.message, false);
        }
    }).catch(function (error) {
        console.log("error: ", error);
    });
}
api.wishListAdd = apiWishListAdd

function apiWishListRemove() {
    var url = baseUrl + "/rest/V1/removewishlist";
    var dataMapping = _getDataMapping();
    var cust_token = dataMapping.customerDetails.api.customerToken;
    var customerId = cust_token ? cust_token : "";
    var reqObj = {
        "customer_id": customerId,
        "sku": targetWishlistObj.skuName
    };
    sendApiRequest(reqObj, url, bearerTokenConfig, "POST", function (status, resp) {
        if (status && resp) {
            if (resp.status) {
                $(targetWishlistObj.targetParent).find(".wishlist-remove-event").removeClass("active");
                $(targetWishlistObj.targetParent).find(".wishlist-add-event").addClass("active");     
                console.log("removed from wishlist")
            }
            resp.message && showToasterMsg(resp.message, resp.status);
        }
    });
}
api.wishListRemove = apiWishListRemove
/********************* Wishlist Api Call Ends *********************/


function addEventWishlistProduct() {
    $(".wishlist-event").unbind();
    $(".wishlist-event").on("click", function (e) {
        if (__is_loginUSer()) {
            var el = $(this).parents('.wishlist-parent');
            var data = $(el).attr("data-wishlist")
            if (data) {
                targetWishlistObj = JSON.parse(data)
                targetWishlistObj.targetParent = el;
                if ($(this).hasClass("wishlist-add-event")) {
                    api.wishListAdd()
                } else if ($(this).hasClass("wishlist-remove-event")) {
                    api.wishListRemove()

                }
            }
        } else {
            showPopup("show-mobile")
        }
    })
}


		

var targetWishlistObj = {
    targetParent: {},
    productId: null,
    skuName: null,
}

var lv2Clicked = false;
var lv2Clickeddisc = false;
var lv2Clickedtrend = false;
var lv2urlValue = "";
/********************* AUTO SUGGESTIVE RENDER STARTS ********************/
function renderAutoSuggestive() {
    var dataMapping = _getDataMapping()
    var searchKeywords = dataMapping.autoSuggestive.autoSuggestiveData.searchTerms;
    var trending_keywords = dataMapping.autoSuggestive.autoSuggestiveData.trendingKeywords;
    var discover_more = dataMapping.autoSuggestive.autoSuggestiveData.discoverMore;
    var discover_moreLv2 = dataMapping.autoSuggestive.autoSuggestiveData.discoverMoreLv2;
    var trending_moreLv2 = dataMapping.autoSuggestive.autoSuggestiveData.trendingMoreLv2;
    var sixTrendingKeywords = [];

    if (trending_keywords) {
        sixTrendingKeywords = matchMedia("(max-width: 767px)").matches ? trending_keywords.slice(0, 4) : trending_keywords.slice(0, 6);
    }
    var sixDiscoverMore = discover_more && discover_more.slice(0, 8);
    var sixDiscoverMoreLv2 = discover_moreLv2 && discover_moreLv2.slice(0, 8);
    var sixTrendingMoreLv2 = trending_moreLv2 && trending_moreLv2.slice(0,8);
    var trendingli = "";
    var discoverli = "";
    var eachSearchLi = '';
    var discoverLv2li = '';
    var trendingLv2li = '';

    if (searchKeywords == '' || searchKeywords == null) {
        $('.product-suggestion-text-div').addClass('dsp-none');
    } else {
        $('.product-suggestion-text-div').removeClass('dsp-none');
    }

    if (trending_keywords == '' || trending_keywords == null) {
        $('.trending-main-section').addClass('dsp-none');
    }
    // else {
    //     $('.trending-main-section').removeClass('dsp-none');
    // }

    if (discover_more == '' || discover_more == null) {
        $('.discover-more-main-section').addClass('dsp-none');
    }
    // else {
    //     $('.discover-more-main-section').removeClass('dsp-none');
    // }

    searchKeywords && Object.keys(searchKeywords).forEach(function (eachData) {
        var redirectionLink = domainUrl + "/emi-store/search.html?q=" + searchKeywords[eachData]['term' + (parseInt(eachData) + 1) + ''];
        // var redirectionLink =  "http://localhost:4502/content/emistoremarketplace/search.html?q="+ searchKeywords[eachData]['term' + (parseInt(eachData) + 1) + ''];
        var textVal = searchKeywords[eachData]['term' + (parseInt(eachData) + 1) + ''];
        textVal = textVal.replace(/[;'"<>`()]+/g,'');
        eachSearchLi += '' +
            '<div class="product-suggestion-li search-redirection-event auto-suugest-event-dl search-card-css"  data-auto-suggest="' + textVal + '" data-redirection="' + redirectionLink + '" data-SkuName="' + textVal + '" data-section-name="Recently search" >' +
            '    <div class="history-icon-div">' +
            '        <img class="recent-search" src="/content/dam/emistoremarketplace/index/emi-mall-dam/common/recent-search.svg" alt="history">' +
            '    </div>' +
            '    <a class="history-direction">' +
            '        <span class="suggestion-title-text">' + textVal + '</span>' +
            '    </a>' +
            '    <div class="close-icon-div search-history-text">' +
            '        <img src="/content/dam/emistoremarketplace/index/emi-mall-dam/common/left-diagonal-arrow.svg" alt="close">' +
            '    </div>' +
            '</div>';
    });

    trending_keywords && Object.keys(sixTrendingKeywords).forEach(function (eachData) {
        var textVal = sixTrendingKeywords[eachData].trending_keywords;
        var titleTxt = subStrVal(textVal);
        sixTrendingKeywords[eachData].url = sixTrendingKeywords[eachData].url + "&type=trend";
        trendingli += '' +
            '<div class="trending-product-li auto-suugest-event-dl tags" data-auto-suggest="' + titleTxt + '" data-section-name="Trending near you">' +
            '    <a href="' + sixTrendingKeywords[eachData].url + '"><span class="trending-product-text tile-text">' + titleTxt + '</span></a>' +
            '</div>'
    });
    discover_more && Object.keys(sixDiscoverMore).forEach(function (eachData) {
        var textVal = sixDiscoverMore[eachData].trending_keywords;
        var titleTxt = subStrVal(textVal);
        sixDiscoverMore[eachData].url = sixDiscoverMore[eachData].url + "&type=disc";
        discoverli += '' +
            '<div class="trending-product-li auto-suugest-event-dl discover-moreL2-event tags" data-auto-suggest = "' + titleTxt + '" data-section-name="Discover More"  >' +
            '    <a href="' + sixDiscoverMore[eachData].url + '"><span class="trending-product-text tile-text" >' + titleTxt + '</span></a>' +
            '</div>'
    });

    if (lv2Clickeddisc) {
        discover_moreLv2 && Object.keys(sixDiscoverMoreLv2).forEach(function (eachData) {
            var textVal = sixDiscoverMoreLv2[eachData].trending_keywords;
            var titleTxt = subStrVal(textVal);
            sixDiscoverMoreLv2[eachData].url = sixDiscoverMoreLv2[eachData].url + "&type=disc";
            discoverLv2li += '' +
                '<div class="trending-product-li auto-suugest-event-dl" data-auto-suggest = "' + titleTxt + '" data-section-name="Discover More Lvl2"  >' +
                '    <a href="' + sixDiscoverMoreLv2[eachData].url + '"><span class="trending-product-text tile-text" >' + titleTxt + '</span></a>' +
                '</div>'
        });

        trending_moreLv2 && Object.keys(sixTrendingMoreLv2).forEach(function (eachData) {
            var textVal = sixTrendingMoreLv2[eachData].trending_keywords;
            var titleTxt = subStrVal(textVal);
            sixTrendingMoreLv2[eachData].url = sixTrendingMoreLv2[eachData].url + "&type=trend";
            trendingLv2li += '' +
                '<div class="trending-product-li auto-suugest-event-dl" data-auto-suggest = "' + titleTxt + '" data-section-name="Discover More Lvl2"  >' +
                '    <a href="' + sixTrendingMoreLv2[eachData].url + '"><span class="trending-product-text tile-text" >' + titleTxt + '</span></a>' +
                '</div>'
        });

        if (discoverLv2li) {
            $(".discover-more-parent").html(discoverLv2li);
            $(".discover-more-main-section").removeClass("dsp-none");
        } else {
            if (discoverli) {
                $(".discover-more-parent").html(discoverli);
                $(".discover-more-main-section").removeClass("dsp-none");
            }
        }
    } else {
        if (discoverli) {
            $(".discover-more-parent").html(discoverli);
            $(".discover-more-main-section").removeClass("dsp-none");
        }
    }

    if (lv2Clickedtrend) {
        trending_moreLv2 && Object.keys(sixTrendingMoreLv2).forEach(function (eachData) {
            var textVal = sixTrendingMoreLv2[eachData].trending_keywords;
            var titleTxt = subStrVal(textVal);
            sixTrendingMoreLv2[eachData].url = sixTrendingMoreLv2[eachData].url + "&type=trend";
            trendingLv2li += '' +
                '<div class="trending-product-li auto-suugest-event-dl" data-auto-suggest = "' + titleTxt + '" data-section-name="Discover More Lvl2"  >' +
                '    <a href="' + sixTrendingMoreLv2[eachData].url + '"><span class="trending-product-text tile-text" >' + titleTxt + '</span></a>' +
                '</div>'
        });

        if (trendingLv2li) {
            $(".trending-parent").html(trendingLv2li);
            $(".trending-main-section").removeClass("dsp-none")
        } else {
            if (trendingli) {
                $(".trending-parent").html(trendingli);
                $(".trending-main-section").removeClass("dsp-none")
            }
        }
    } else {
        if(trendingLv2li){
            $(".trending-parent").html(trendingLv2li);
            $(".trending-main-section").removeClass("dsp-none")
        }
        else if(trendingli) {
            $(".trending-parent").html(trendingli);
            $(".trending-main-section").removeClass("dsp-none")
        }
    }

    // if (trendingli) {
    //     $(".trending-parent").html(trendingli);
    //     $(".trending-main-section").removeClass("dsp-none")
    // }

    if (eachSearchLi) {
        $('.auto-suggest-search-parent').html(eachSearchLi);
    };

    if (trendingli || discoverli || eachSearchLi || discoverLv2li) {
        // $(".product-trending-near-div").removeClass("dsp-none");
        $(".bfs-menu-search-main").addClass("auto-suggestive");
        $(".suggestion-drawer-wrapper").removeClass("dsp-none");
    }

    autoSuggestEvents();
    autoSuggestdlCall();

    if($(".product-suggestion-text-div").hasClass("dsp-none")){
        $(".trending-main-section").addClass("margin-top-alignment");
    }else{
        $(".trending-main-section").removeClass("margin-top-alignment");
    }

}
render.autoSuggestive = renderAutoSuggestive;
/********************* AUTO SUGGESTIVE RENDER ENDS ********************/

function renderAutoSearch() {
    var dataMapping = _getDataMapping()
    var productList = dataMapping.autoSearch.api.response.products;
    var searchKey = dataMapping.autoSearch.api.searchKey;
    var popularProductList = productList.filter((products) => products.doctype == "POPULAR_PRODUCTS");
    var promotedSuggestion = productList.filter((products) => products.doctype == "PROMOTED_SUGGESTION");
    var topSearchQueries = productList.filter((products) => products.doctype == "TOP_SEARCH_QUERIES");
    var keywordSuggestion = productList.filter((products) => products.doctype == "KEYWORD_SUGGESTION");
    promotedSuggestion = promotedSuggestion.concat(topSearchQueries,keywordSuggestion);
    var autoSearchResultHtml = "";
    var autoSearchPopularResultHtml = "";
    var domainSearchUrl = domainUrl + "/emi-store/search.html?q=";

    if(promotedSuggestion.length > 0) {
      promotedSuggestion.forEach(function (eachData, suggestionCount) {
          if(suggestionCount < 10) {
              var searchRedirectionUrl = domainSearchUrl.concat(eachData.autosuggest.split(' ').join('+'));
              var formattedAutoSearchHtml = eachData.autosuggest.toLowerCase().includes(searchKey.toLowerCase()) ? getFormattedAutoSearch(searchKey, eachData.autosuggest) : eachData.autosuggest;
              autoSearchResultHtml +=
              '<div class="product-suggestion-li">'+
              '   <div class="history-icon-div">'+
              '       <img class="img-contain100" src="/content/dam/emistoremarketplace/index/emi-mall-dam/common/search-16.svg" alt="history">'+
              '   </div>'+
              '   <a href="'+searchRedirectionUrl+'" class="history-direction">'+
              '       <span class="suggestion-title-text">'+formattedAutoSearchHtml+'</span>'+
              '   </a>'+
            //   '   <div class="close-icon-div">'+
            //   '       <img src="/content/dam/emistoremarketplace/index/emi-mall-dam/common/left-diagonal-arrow.svg" alt="close">'+
            //   '   </div>'+
              /*'   <div class="close-icon-div">'+
              '       <img src="/content/dam/emistoremarketplace/index/emi-mall-dam/common/left-diagonal-arrow.svg" alt="close">'+
              '   </div>'+*/
              '</div>';
          }
      });
    }
    if(popularProductList.length > 0) {
       autoSearchResultHtml +=
       '<div class="popular-products-div">'+
       '   <span class="trending-near-text auto-suugest-event-parent-dl search-card-title auto-suggest-popular-products">Popular Products</span>'+
       '</div>'
       $(".product-search-suggestion-ul").html(autoSearchResultHtml);

      popularProductList.forEach(function (eachData ,productsCount) {
          if(productsCount < 5) {
               autoSearchPopularResultHtml +=
              '<div class="popular-products-li">'+
              '   <div class="popular-products-li-card-desc d-flex-center">'+
              '       <div class="popular-products-card">'+
              '           <img class="product-image" src="'+eachData.product_small_image_url+'" alt="product">'+
              '       </div>'+
              '       <a href="'+eachData.product_url+'" class="product-direction">'+
              '           <span class="product-title-text">'+eachData.product_name+'</span>'+
              '           <span class="products-price-text">â‚¹'+eachData.variants[0].city_min_price+'</span>'+
              '       </a>'+
              '   </div>'+
              '   <div class="product-buyNow">'+
              '       <a href="'+eachData.product_url+'">'+
              '           <span>BUY NOW</span>'+
              '       </a>'+
              '   </div>'+
              '</div>';
          }

      });
    } else {
        $(".product-search-suggestion-ul").html(autoSearchResultHtml);
    }
   if(promotedSuggestion.length > 0 || popularProductList.length > 0) {
      $(autoSearchPopularResultHtml).insertAfter(".auto-suggest-popular-products");
      $(".product-trending-near-div").addClass("dsp-none");
      $('.product-suggestion-text-div').addClass('dsp-none');
      $(".product-search-revamp-suggestion-div").removeClass("dsp-none");
   }
}
render.autoSearch = renderAutoSearch;

function getFormattedAutoSearch(searchKey, autoSearchString) {
        var searchKeyLength = searchKey.length;
        var startIndex = 0, index, indexArray = [];
        var tempSearchKey = searchKey.toLowerCase();
        var tempAutoSearchString = autoSearchString.toLowerCase();
        var autoSuggestHtml="";
        while ((index = tempAutoSearchString.indexOf(tempSearchKey, startIndex)) > -1) {
            indexArray.push(index);
            startIndex = index + searchKeyLength;
        }
        var startIndex = 0;
        indexArray.forEach( function (eachIndex) {
            if(startIndex == eachIndex) {
                autoSuggestHtml += '<span class ="suggest-ft-blue">'+autoSearchString.substring(eachIndex, eachIndex+searchKeyLength)+'</span>';
            }else {
                autoSuggestHtml += '<span class ="suggest-ft-black">'+autoSearchString.substring(startIndex, eachIndex)+'</span>';
                autoSuggestHtml += '<span class ="suggest-ft-blue">'+autoSearchString.substring(eachIndex, eachIndex+searchKeyLength)+'</span>';
            }
            startIndex = eachIndex + searchKeyLength;
        });
        if(startIndex + 1 < autoSearchString.length) {
           autoSuggestHtml += '<span class ="suggest-ft-black">'+autoSearchString.substring(startIndex, autoSearchString.length)+'</span>';
        }
        return autoSuggestHtml;
}
/************************* AUTO SUGGESTIVE BIZ STARTS *************************/
window.addEventListener('DOMContentLoaded', function() {
    $("#searchBox1").on("input", function () {
        var value = $(this).val()
        value = value.replace(/[;'"<>`()]+/g,'');
        $(this).val(value)
        if (value.length == 0) {
           $(".product-search-revamp-suggestion-div").addClass("dsp-none");
            api.autoSuggestive();
        } else {
            value = value.trim();
            if(value.length > 0) {
              $(".bfs-menu-search-main").addClass("auto-suggestive");
              $(".suggestion-drawer-wrapper").removeClass("dsp-none");
              api.autoSearch(value);
            } else {
                $(".suggestion-drawer-wrapper").addClass("dsp-none");
                $(".bfs-menu-search-main").removeClass("auto-suggestive");
            }
        }
    });
    $(window).scroll(function(){
        if(!$(".product-search-revamp-suggestion-div").hasClass("dsp-none")) {
            $(".suggestion-drawer-wrapper").addClass("dsp-none");
            $(".bfs-menu-search-main").removeClass("auto-suggestive");
        }
    });
    $("#searchformId").on("submit", function (e) {
        var searchValue = $(this).find(".auto-suggestive-form-control").val();
        localStorage.setItem("searchItem", searchValue);
        localStorage.setItem("reffererPath", window.location.href);
        // api.saveSearchTerm(searchValue)
    });

    /*  $('magnifying-glass-icon').on('click', function () {
         $('.auto-suggestive-form-control').val();
     }); */

});

function autoSuggestEvents() {
    /*   $('.history-icon-div').on('click', function () {
          var selectedTextVal = $(this).parents(".product-suggestion-li").find('.suggestion-title-text').text();
          console.log(selectedTextVal);
          $('#searchBox1').val(selectedTextVal);
      }); */

    $('.search-redirection-event').on('click', function () {
        var redirectLink = $(this).attr('data-redirection');
        var skuName = $(this).attr('data-SkuName');
        localStorage.setItem('searchItem', skuName);
        location.href = redirectLink;
    });

    $('.search-history-text').click(function (e) {
        var clickedSearchText = $(this).parents('.product-suggestion-li').find('.suggestion-title-text').text();
        $('.auto-suggestive-event').val(clickedSearchText)
        $(this).parents().children().find(".suggestion-drawer-wrapper").addClass("dsp-none");
        $(this).parents().find(".bfs-menu-search-main").removeClass("auto-suggestive");
        e.stopPropagation();
    })

};

function autoSuggestdlCall() {
    try {
        $(".auto-suugest-event-dl").on("click", function () {
            // debugger;
            var autoSuggestLi = $(this).attr("data-auto-suggest");
            var autoSuggestMain = $(this).attr('data-section-name');
            var data = {
                "autoSuggestLi": autoSuggestLi,
                "autoSuggestMain": autoSuggestMain
            }
            dlAutoSuggest(data);
        });
    } catch (err) {
        console.error('%c ' + err, 'color:white')
    }
}

function subStrVal(data) {
    var textVal = data;
    var tileText = textVal.substring(0, 28)
    return tileText;
}

function readUrlParam(){
    var queryString = window.location.search;
    var parameters = new URLSearchParams(queryString);
    var value = parameters && parameters.get('q');
    return value;
};
/************************* AUTO SUGGESTIVE BIZ ENDS *************************/
/********************* AUTO SUGGESTIVE API STARTS *********************/
function apiAutoSuggestive() {
    var url = baseUrl + "/rest/V1/suggestive/search/result";
    var dataMapping = _getDataMapping();
    var cust_token = dataMapping.customerDetails.api.customerToken;
    var custToken = cust_token ? cust_token : "";
    var searchVal = localStorage.getItem("searchItem") ? localStorage.getItem("searchItem") : "";
    var cityId = localStorage.getItem("cityId") ? localStorage.getItem("cityId") : "";
    var reqObj = {
        "city_id": cityId,
        "keywords": ""
    }
    if($("meta[name=pageType]").attr("content") == 'search'){
        var urlValue = lv2urlValue;
        var value = readUrlParam();
        if(urlValue == "disc"){
            lv2Clickeddisc = true;
            reqObj.discover_l2 = value;
            reqObj.trending_l2 = value;
        }
        if (urlValue == "trend") {
            lv2Clickedtrend = true;
            reqObj.trending_l2 = value;
        }
    }
    sendApiRequest(reqObj, url, "", "POST", function(status, resp) {
        if (status && resp.status && $(".product-search-revamp-suggestion-div").hasClass("dsp-none")) {
            var dataMapping = _getDataMapping()
            dataMapping.autoSuggestive.autoSuggestiveData.trendingKeywords = resp.trending_keywords;
            dataMapping.autoSuggestive.autoSuggestiveData.discoverMore = resp.discover_more;
            dataMapping.autoSuggestive.autoSuggestiveData.searchTerms = resp.search_terms;
            dataMapping.autoSuggestive.autoSuggestiveData.discoverMoreLv2 = resp.discover_more_l2;
            dataMapping.autoSuggestive.autoSuggestiveData.trendingMoreLv2 = resp.trending_keywords_l2;
            _setDataMapping(dataMapping)
            render.autoSuggestive()
        } else if($(".product-search-revamp-suggestion-div").hasClass("dsp-none")) {
            $(".suggestion-drawer-wrapper").addClass("dsp-none");
            $(".bfs-menu-search-main").removeClass("auto-suggestive");
        }
    }, custToken, "json")
}
api.autoSuggestive = apiAutoSuggestive;

function apiSaveSearchTerm(val) {
    var url = baseUrl + "/rest/V1/suggestive/search/term/save";
    var dataMapping = _getDataMapping();
    var cust_token = dataMapping.customerDetails.api.customerToken;
    var custToken = cust_token ? cust_token : "";
    var searchVal = val;
    searchVal = searchVal.replace(/[;'"<>`()%]+/g,'');
    var reqObj = {
        "keywords": searchVal
    }
    sendApiRequest(reqObj, url, '', "POST", function(status, resp) {


        if (status && resp.status) {
            console.log("SUCCESSFULLY SAVED THE SEARCH KEYWORD");
        }
    }, custToken, "json")
}
api.saveSearchTerm = apiSaveSearchTerm;

/********************* AUTO SUGGESTIVE API ENDS *********************/

function apiAutoSearch(searchKey) {
    var cityId = localStorage.getItem("cityId") ? localStorage.getItem("cityId") : "";
    var url = domainUrl + "/dps/web/api/autosearch"+"?query="+searchKey+"&city_id="+cityId;

    sendApiRequest("", url, bearerTokenConfig, "GET", function (status, data) {
        if (status && data.response) {
            var dataMapping = _getDataMapping()
            dataMapping.autoSearch.api.response = data.response;
            dataMapping.autoSearch.api.status = status;
            dataMapping.autoSearch.api.searchKey = searchKey;
            _setDataMapping(dataMapping)
            render.autoSearch()
        } else {
            $(".suggestion-drawer-wrapper").addClass("dsp-none");
            $(".bfs-menu-search-main").removeClass("auto-suggestive");
        }
    }, "", "json")
}
api.autoSearch = apiAutoSearch;
